---
template: "post"
date: 2021-05-15
title: "『エンジニアのためのGitの教科書［上級編］』を読んだ"
emoji: 📚
category: "Book"
tags:
---

『[エンジニアのためのGitの教科書［上級編］](https://www.amazon.co.jp/dp/B01AAIN85K)』の読書メモです。

# 感想

Git がデータをどう管理しているかを、コマンドを叩いたあとの .git ディレクトリの中身を見ながら追っていく本です。
init、add、commit ... という風に、コマンドと共に内部構造の説明を進めていく構成がわかりやすかったです。80ページほどの本なので読みやすいです。

# 読書メモ

## Section-01 Git のバージョン管理の仕組みを知る 〜初級編〜

- .git 以下のファイル構造
  - .git/HEAD：現在のブランチを指すシンボリック参照
  - .git/config：リポジトリの設定ファイル。リポジトリの設定、リモートリポジトリ、上流ブランチの情報などが格納される。
  - .git/info/exclude：除外ファイルのパターンが記録されるファイル
  - .git/objects：オブジェクトファイルとパックファイルを格納するディレクトリ
    - オブジェクトファイルは、検索効率のためにハッシュ値の先頭2文字がディレクトリ名に利用され、それ以降のハッシュ値がファイル名として利用される。
  - .git/refs：各ブランチの参照と tag オブジェクトを格納するディレクトリ
    - .git/refs/heads：ローカルブランチの参照が格納されるディレクトリ
    - .git/refs/remotes/origin：（origin の）リモート追跡ブランチの参照が格納されるディレクトリ
    - .git/refs/tags：tag オブジェクトが格納されるディレクトリ
  - .git/index：ステージングされたファイルの情報を管理するバイナリファイル
  - .git/logs：ブランチなどの参照への更新を記録するディレクトリ
    - .git/logs/HEAD には HEAD の参照の変更履歴が格納されている。同じ情報を `git reflog` で確認できる。
- オブジェクトファイル
  - blob オブジェクト
    - データをzlib で圧縮したもの。
    - データの内容のみを持つ。
    - 同一内容のデータは同じ blob オブジェクトとなる。
  - commit オブジェクト
    - スナップショットを表す tree オブジェクトへの参照を持つ。
    - 親コミットの commit オブジェクトへの参照を持つ。
    - コミットの author、時刻、コミットメッセージなどを持つ。
  - tree オブジェクト
    - 1つ以上の blob オブジェクトへの参照を持つ。
    - tree オブジェクトへの参照（1階層分のディレクトリの情報）を持つ。
    - それぞれのオブジェクトに対応するファイル・ディレクトリのファイルモード・パス名を持つ。

## Section-02 Git のバージョン管理の仕組みを知る 〜中級編〜

- tag オブジェクト
  - タグの詳細と、commit オブジェクトへの参照を持つ。
- git remote や git push、git clone などを実行すると、リモートリポジトリや上流ブランチの情報が .git/config に書き込まれる。
  - git push や git clone を実行すると、リモートリポジトリ上のオブジェクトの参照とローカルリポジトリのオブジェクトの参照が一致する。
- git checkout
  - .git/HEAD の参照と .git/logs/HEAD の記録が更新される。
- git merge
  - fast-forward マージではブランチの参照ファイルの参照だけが更新される。
  - recursive 戦略のマージでは、マージ先とマージ元の commit オブジェクトの共通祖先の commit オブジェクトが探索され、2つの親を持つマージコミットが作成される。
- git rebase 
  - 同じ内容で親が異なる commit オブジェクトを作成することでブランチの祖先を変更する。

## Section-03 Git のバージョン管理の仕組みを知る 〜上級編〜

- オブジェクトファイルよりも効率的な packfile によって、効率的にオブジェクトが管理される。
  - packfile に対して、blob オブジェクトなどのオブジェクトファイルは loose object format と呼ばれる。
- git fetch、git merge、git push コマンドなどの実行時に、`git gc --auto` コマンドが実行される。
  - `--auto` オプションにより、オブジェクトファイルが規定値より多い、または、packfile が既定値より多い場合にのみ `git gc` が実行される。
- git gc
  - .git/refs 以下の参照を記録したファイルが、.git/packed-refs にまとめられる。
  - .git/objects 以下のオブジェクトファイルが、.git/objects/pack にパックファイルとして圧縮される。
    - インデックスファイル（.idx）には、元のオブジェクトファイルへの参照がまとめられる。
    - 各オブジェクトファイルは zlib で圧縮され、パックファイル（.pack）に格納される。
    - パックファイルは、直近のファイルが元ファイルとして格納され、それより前のファイルは差分で格納される。
